$(function(){var e,t=$("body"),a=$(".flash"),s=t.hasClass("schedulePage");a.is(":visible")&&a.setRemoveTimeout(5e3);var i=new Gettext({domain:"messages"});setEditableTextfields(),$(".attributeSelect").each(function(){$(this)}),$(window).on("beforeunload",function(){return $(".unsaved").length>0?"There are some unsaved changes on this page.":void 0}),$('span[class$="Toggle"]').on("click",function(){resetActiveField();var e=$(this).attr("class"),a=$("#"+e.substr(0,e.length-6));a.is(":visible")?(resetActiveField(),a.slideToggle("normal",function(){r=new $.fn.dataTable.FixedHeader(n)})):(a.slideToggle(),t.children(".fixedHeader").each(function(){$(this).remove()}))}),$(window).on("resize",function(){e||(t.children(".fixedHeader").each(function(){$(this).remove()}),d.draw(),r=new $.fn.dataTable.FixedHeader(d))}),$(".editableTable td").on("mouseover mouseout",function(){var e=$("colgroup"),t=$(this).prevAll("td").length;$(e[t]).toggleClass("hover")}),$("table").on("mouseleave",function(){$("colgroup").removeClass("hover")}),$(document).on("submit",".standardForm",function(){if(confirm(i.gettext("Are you sure you want to submit the form? All unsaved changes will be lost!"))){var e=$(this),t=e.parent();if(t.toggleLoadingImage(),"productForm"==e.attr("id")){var a={};e.find(".dynamicList").each(function(){var e=[],t=$(this);t.children("li").each(function(){l={};var t=$(this);t.children("span").each(function(){var e=$(this);l[e.attr("class").split(" ")[0]]=e.html()}),e.push(l)}),a[t.attr("class").split(" ")[0]]=e})}else a={};console.log(a),e.ajaxSubmit({target:"#"+e.attr("id"),type:"post",data:{extraData:a},success:function(e){e.redirect&&location.reload(!0),setEditableTextfields(),t.toggleLoadingImage()}})}return!1}),$(document).on("dblclick",".editableTable td",function(){var e=$(this);if(!e.hasClass("activeField")&&!e.hasClass("editTextfield")&&!e.hasClass("unEditable")){resetActiveField(),e.addClass("activeField");var a,s=e.text(),i=$("#editPanel");i.appendTo(t);var l=i.children(":first"),r=e.offset(),o=e.outerWidth();i.css("width",o-1),i.css("margin-left",r.left),i.css("top",r.top+e.outerHeight(!0)).show();var c=$(".standardForm"),u=(n.attr("id"),n.attr("class").split(" ")[1].substr(7)),h=e.attr("class").split(" ")[0].substr(u.length).lowerize();if(e.hasClass("editSelect")||e.hasClass("editMultiSelect")){a=e.hasClass("editMultiSelect")?c.find('[name="'+u+"["+h+'][]"]').clone():c.find('[name="'+u+"["+h+']"]').clone();var v=a.find("option");if(e.hasClass("excludeCurrent")){var p=d.row(e.parent()).data()[0];v.each(function(){var e=$(this);e.val()==p&&e.detach()})}e.find('span[class^="option"]').each(function(){var e=$(this).attr("class").substr(7);v.filter(function(){return $(this).val()==e}).attr("selected","selected")}),l.replaceWith(a)}else if(e.hasClass("editDatetime")){if(""!=s){var f,g=s.split("-");f=new Date(g[2],g[1]-1,g[0])}else f=new Date;a=$("<input />",{id:"mydate",value:s}),l.replaceWith(a).datePicker().focus()}else if(e.hasClass("editFile")||e.hasClass("editImage")){var m=$("<form />",{action:baseUrl+"/upload-file",enctype:"multipart/form-data","class":"fileForm"});$("<input />",{type:"hidden",name:"fileMeta",value:e.children(".fileMeta").html()}).appendTo(m),a=$("<input />",{type:"file",name:"uploadFile"}).appendTo(m),l.replaceWith(m).focus()}else a=c.find('[name="'+u+"["+h+']"]').clone(),a.val(s),l.replaceWith(a);a.addClass("editInput").focus()}}),$(window).keypress(function(e){13==e.keyCode&&$("#editPanel").is(":visible")&&updateEditedField()}),$(document).on("click","#editDone",function(){updateEditedField()});var n=$(".editableTable");if(n.length>0){$(".tableWrapper").fadeIn();var d=$(".editableTable, #changelogs").DataTable({lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"All"]],stateSave:!0,aoColumnDefs:[{bSortable:!1,aTargets:n.find("th").length-1},{visible:!1,targets:[0]}],pagingType:"full_numbers",order:[[1,"asc"]],dom:'C<"clear">lfrtip',colVis:{order:"alpha"},iDisplayLength:5}).on("length.dt",function(){t.children(".fixedHeader").each(function(){$(this).remove()}),d.draw(),r=new $.fn.dataTable.FixedHeader(d)}),r=new $.fn.dataTable.FixedHeader(d);$("#saveChanges").on("click",function(){var e=[],t=$(s?".scheduleTable":".editableTable"),a=t.attr("class").split(" ")[1].substr(7),l=!1;return t.find("tbody .unsaved").each(function(){var t=$(this),s={};return s.id=d.row(t).data()[0],t.children("td").each(function(){var e=$(this);if(e.hasClass("required")){var t="";t=e.hasClass("editTextfield")?e.children("textarea").val():e.text(),empty(t)&&(e.addClass("redBorder"),l=!0)}if(e.removeClass("redBorder"),!e.hasClass("delete")){var i=e.attr("class").split(" ")[0].substr(a.length);if(e.hasClass("editImage")){var n=e.find(".fileImage");if(n.hasClass("changed")){var d=n.children("img");if(d.length>0){var r=d.attr("src").split("/");s[i]=r[r.length-1]}else s[i]=null}}else if(e.hasClass("editFile")){var o=e.children(".fileName");if(o.hasClass("changed")){var c=$.trim(o.html());s[i]="-"!=c?c:null}}else if(e.hasClass("editSelect")){var u=e.children("span");u.length>0&&(s[i]=u.attr("class").substr(7))}else if(e.hasClass("editMultiSelect")){var h=[];e.children("span").each(function(){h.push($(this).attr("class").substr(7))}),s[i]=h.length>0?h:null}else if(e.hasClass("editTextfield"))s[i]=e.children("textarea").val();else if(e.hasClass("editList")){var v=[{}];e.find("ul li").each(function(){var e=$(this),t={};e.children("span").each(function(){t[$(this).attr("class").split(" ")[0]]=$(this).text()}),v.push(t)}),s[i]=v}else s[i]="-"==$.trim(e.text())?null:e.text()}}),e.push(s),l?!1:void 0}),l?(addMessage(i.gettext("Some required fields are empty.")),!1):void(e.length>0?($("tr.unsaved").removeClass("unsaved"),$.ajax({url:baseUrl+"/admin/"+t.attr("id")+"/save",type:"POST",data:{entities:e}}).success(function(e){console.log(e),1==e.success&&location.reload(!0),addMessage(e.message)}).error(function(e,t,a){console.log(e),console.log(t),console.log(a),addMessage(i.gettext("Something with wrong, please try again."))})):addMessage(i.gettext("There are no changes to save.")))}),$(document).on("click","td.delete",function(){if(confirm(i.gettext("Are you sure about this action?"))){var e=$(this),t=n.attr("id"),a=d.row(e.parent()).data()[0];$.ajax({url:baseUrl+"/admin/"+t+"/remove",type:"POST",data:{id:a}}).success(function(t){1==t.success&&(d.row(e.parent()).remove().draw(),location.reload(!0)),addMessage(t.message)}).error(function(){addMessage(i.gettext("Something with wrong, please try again."))})}}),$(document).on("click",".textEditorToggle",function(){var a=$(this),s=a.siblings("textarea");s.addClass("activeTextfield");{var i=$("<div/>",{id:"stageWrapper"}).prependTo($("body")),l=$("<div/>",{id:"stage"}).appendTo(i),n=$("<div/>",{id:"textareaWrapper"}).appendTo(l),d=$("<textarea/>",{id:"stageTextarea",html:s.val()}).appendTo(n);$("<span />",{"class":"done",html:"Done"}).appendTo(n)}$.sceditor.plugins.xhtml.disallowedAttribs={"*":{style:null,"class":null,id:null,div:null,lang:null}},d.sceditor({plugins:"xhtml",style:"../css/scedit/jquery.sceditor.default.min.css",emoticonsRoot:"../images/",disallowedTags:["style","div"]}),e=i,i.focusLight(),t.addClass("unscrollable")}),$(document).on("click","#stage .done",function(){var a=$(".activeTextfield"),s=$("#stageTextarea").sceditor("instance").val();a.val()!=s&&(a.closest("tr").addClass("unsaved"),a.html(s)),a.removeClass("activeTextfield"),e.unfocusLight().detach(),t.removeClass("unscrollable")}),$(document).on("click",".editAttributes",function(){var a=$(this),s=a.siblings(".attributeGuide"),i=$("<div/>",{id:"stageWrapper","class":"wider"}).prependTo(t),l=$("<div />",{id:"stage"}).appendTo(i),n="";s.children("span").each(function(){var e=$(this);n+=e.hasClass("invisible")?'<th class="invisible"':"<th",n+=">"+e.text()+"</th>"});var d=($('<div id="attributeList" class="editListContent"><table><thead><tr>'+n+"</tr></thead><tbody></tbody></table></div>").appendTo(l),$('<div id="editListOptions"><span class="addAttribute button">Add Attribute</span><span class="removeAttribute button">Remove Attribute</span><span class="attributeEditDone button">Done</span> </div>').appendTo(l),$(".editListContent tbody"));a.siblings("ul").children("li").each(function(){var e=$(this),t=$("<tr />");e.children("span").each(function(){var e=$(this),a=$("<td />",{"class":e.hasClass("invisible")?"invisible":""});$("<input />",{value:e.html(),"class":e.attr("class").split(" ")[0]}).appendTo(a),a.appendTo(t)}),t.appendTo(d)}),a.addClass("activeEditedField"),e=i,i.focusLight(),t.addClass("unscrollable")}),$(document).on("click",".addAttribute",function(){var e=$(".activeEditedField"),t=e.siblings(".attributeGuide"),a=$("#attributeList tbody"),s=parseInt(a.find("tr:last-of-type .position").val());s=empty(s)||isNaN(s)?1:s+1;var i=$("<tr />");t.children("span").each(function(){var e=$(this),t=$("<td />",{"class":e.hasClass("invisible")?"invisible":""});$("<input />",{"class":e.attr("class").split(" ")[0],value:e.hasClass("position")?s:""}).appendTo(t),t.appendTo(i)}),i.appendTo(a)}),$(document).on("click",".attributeEditDone",function(){var a=$(".activeEditedField"),s=a.siblings("ul");if(s.empty(),$("#stage .editListContent").find("tbody").children("tr").each(function(){var e=$(this),t=$("<li />");e.children("td").each(function(){var e=$(this),a=e.children("input");if(!e.hasClass("invisible")&&empty(a.val())?(a.addClass("redBorder"),i=!0):a.removeClass("redBorder"),!i){i=!1;var l=e.hasClass("invisible")?a.attr("class")+" invisible":a.attr("class");$("<span />",{"class":l,html:a.val()}).appendTo(t),t.appendTo(s)}})}),!i){var i=!1;a.closest(".editableTable").length>0&&s.children("li").length>0&&a.closest("tr").addClass("unsaved"),e.unfocusLight().detach(),a.removeClass("activeEditedField"),t.removeClass("unscrollable")}}),$(document).on("click",".editListContent tbody tr",function(){$(this).parent().find("tr.active").removeClass("active"),$(this).toggleClass("active")}),$(document).on("click",".removeAttribute",function(){$(".activeEditedField").closest("tr").addClass("unsaved"),$(".editListContent").find("tr.active").detach()})}});